<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flat Rate VAT Calculator (10.5%)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and AutoTable for PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .input-style {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-style:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .summary-box {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
            min-width: 80px; /* Ensure buttons are stable */
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, getDocs, onSnapshot, collection, query, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = 'vat-totals-app';
        const firebaseConfig = {
            apiKey: "AIzaSyC-_vJNicITAlLxIKwDigUwlCNWtUCzfKE",
            authDomain: "vat-totals.firebaseapp.com",
            projectId: "vat-totals",
            storageBucket: "vat-totals.firebasestorage.app",
            messagingSenderId: "124485403709",
            appId: "1:124485403709:web:4044ca5bebd1f9bed91654"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth, userId = null;
    let vatRecordsRef;
    // Cache of latest filtered results for export/print
    let latestInvoices = [];
    let currentFilter = 'all';
    let currentReferenceDate = null; // YYYY-MM-DD or null
    let latestTotals = { hmrc: 0, net: 0, gross: 0 };

        // --- IMPORTANT: GOOGLE APPS SCRIPT WEB APP URL ---
        // This is the URL to your deployed Google Apps Script for Google Sheet integration.
        const GOOGLE_SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzKhb2h7gqPBb0FTHbOWUZV603sceaXKqA80LJuBHWryJbSz9IU6JIYMc_jCwRHSPhR/exec"; 
        // --------------------------------------------------

        setLogLevel('debug'); // Enable Firestore logging
        // Update the top banner total based on the selected mode
        const updateTopBanner = () => {
            const el = document.getElementById('hmrc-top-total');
            const modeSel = document.getElementById('top-total-mode');
            if (!el) return;
            const mode = modeSel ? modeSel.value : 'hmrc';
            let value = 0;
            if (mode === 'net') value = latestTotals.net;
            else if (mode === 'gross') value = latestTotals.gross;
            else value = latestTotals.hmrc; // default hmrc
            el.textContent = `£${Number(value || 0).toFixed(2)}`;
        };

        /**
         * Utility function to determine the start and end dates for filtering
         * based on a chosen filter type and a reference date.
         */
        const getDateRange = (filter, dateString = null) => {
            // Use the provided date string or fall back to the current date
            const refDate = dateString ? new Date(dateString) : new Date();
            const now = refDate; 
            let startDate = new Date(now);
            let endDate = new Date(now); 

            // Reset time for accurate date comparisons
            const resetTime = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate());

            switch (filter) {
                case 'daily':
                    startDate = resetTime(now);
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 1); // End of today
                    break;
                case 'weekly':
                    // Calculate start of the week (Monday) relative to the reference date
                    const day = now.getDay() || 7; // Get day number, make Sunday 7
                    startDate.setDate(now.getDate() - day + 1); // Go back to Monday
                    startDate = resetTime(startDate);
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 7); // End of next Sunday
                    break;
                case 'monthly':
                    startDate = resetTime(new Date(now.getFullYear(), now.getMonth(), 1)); // Start of the month
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1); // Start of next month
                    break;
                case 'yearly':
                    startDate = resetTime(new Date(now.getFullYear(), 0, 1)); // Start of the year
                    endDate = new Date(now.getFullYear() + 1, 0, 1); // Start of next year
                    break;
            }
            return { startDate, endDate };
        };

        // --- Core Application Functions ---

        window.initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Data persistence will not work.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate using the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Shared dataset (no per-user scoping)
                        document.getElementById('user-id').textContent = 'Connected (shared mode)';
                        vatRecordsRef = collection(db, `artifacts/${appId}/vat_records`);
                        console.log("Firebase initialized and authenticated (shared mode). UID:", userId);
                        
                        // Set the default filter date to today
                        const today = new Date().toISOString().split('T')[0];
                        const filterDateInput = document.getElementById('filterDate');
                        if (filterDateInput) {
                            filterDateInput.value = today;
                        }
                        
                        // Wire up top banner mode change
                        const modeSel = document.getElementById('top-total-mode');
                        if (modeSel) modeSel.addEventListener('change', updateTopBanner);

                        // Set up initial listener after successful auth (All Time)
                        window.setupRealtimeListener('all'); 
                    } else {
                        console.log("User signed out or anonymous sign-in failed.");
                        document.getElementById('user-id').textContent = 'Authentication failed. Please check Firebase configuration.';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                document.getElementById('user-id').textContent = 'Firebase connection failed. Please check configuration.';
            }
        };

        // Function to push data to Google Sheets via Apps Script
        const pushToGoogleSheet = async (invoiceData) => {
            if (!GOOGLE_SHEET_API_URL || GOOGLE_SHEET_API_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL_HERE") {
                console.warn("Google Sheet API URL is not set. Data not sent to Sheet.");
                return;
            }

            try {
                // Implementing a simple retry mechanism with exponential backoff
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(GOOGLE_SHEET_API_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Apps Script requires 'no-cors' for simplicity
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: 'create', ...invoiceData })
                    });

                    // In 'no-cors' mode, we can't reliably check the status. 
                    // We assume success unless an underlying network error occurred.
                    console.log(`Attempted to send data to Google Sheet (Try ${i + 1}).`);
                    return; // Exit on successful request attempt (even if response status is unknown)
                }
            } catch (error) {
                console.error("Error sending data to Google Sheet API after retries:", error);
            }
        };

        // Called when a new invoice is submitted
        window.saveInvoice = async (event) => {
            event.preventDefault();
            if (!vatRecordsRef) {
                document.getElementById('status-message').textContent = 'Error: Database connection not ready.';
                return;
            }

            const totalGrossInput = document.getElementById('totalGross');
            const totalGross = parseFloat(totalGrossInput.value);
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const dateValue = document.getElementById('invoiceDate').value;
            
            if (isNaN(totalGross) || totalGross <= 0 || !invoiceNumber || !dateValue) {
                document.getElementById('status-message').textContent = 'Please fill out all fields correctly.';
                document.getElementById('status-message').className = 'text-red-500 font-bold mt-2';
                return;
            }

            // Firestore document IDs cannot contain forward slashes
            if (invoiceNumber.includes('/')) {
                document.getElementById('status-message').textContent = 'Invoice number cannot contain "/".';
                document.getElementById('status-message').className = 'text-red-500 font-bold mt-2';
                return;
            }

            try {
                // VAT Calculations (UK Standard Rate 20%)
                const standardVATRate = 0.20;
                
                // Original Price (Net) = Gross / 1.2
                const netPrice = totalGross / (1 + standardVATRate); 
                
                // 20% VAT component of the Gross price
                const standardVATAmount = totalGross * (standardVATRate / (1 + standardVATRate));
                
                // Flat Rate Scheme (FRS) Calculations (10.5% of gross turnover)
                const flatRatePercent = 0.105; 
                const hmrcFlatRateAmount = totalGross * flatRatePercent;

                // PCW Retained Profit (VAT retained by business)
                const pcwRetainedVat = standardVATAmount - hmrcFlatRateAmount;

                // Final PCW Amount = Net Price + PCW Retained VAT
                const finalPcwAmount = netPrice + pcwRetainedVat;

                const newInvoice = {
                    invoiceNumber: invoiceNumber,
                    date: dateValue,
                    totalPrice: parseFloat(totalGross.toFixed(2)), // Gross (Number)
                    netPrice: netPrice.toFixed(2), 
                    vat20Percent: standardVATAmount.toFixed(2),
                    hmrcFlatRateAmount: hmrcFlatRateAmount.toFixed(2),
                    pcwRetainedVat: pcwRetainedVat.toFixed(2),
                    finalPcwAmount: finalPcwAmount.toFixed(2), 
                    timestamp: new Date(dateValue), // Use a Date object for range queries
                    createdAt: serverTimestamp(),
                };

                // 1. Save to Firestore using invoice number as the document ID
                await setDoc(doc(vatRecordsRef, invoiceNumber), newInvoice);

                // 2. Push to Google Sheet (Async, runs in the background)
                const sheetData = {
                    invoiceNumber: invoiceNumber,
                    date: dateValue,
                    totalPrice: newInvoice.totalPrice.toFixed(2), 
                    netPrice: newInvoice.netPrice,
                    vat20Percent: newInvoice.vat20Percent,
                    hmrcFlatRateAmount: newInvoice.hmrcFlatRateAmount,
                    pcwRetainedVat: newInvoice.pcwRetainedVat,
                    finalPcwAmount: newInvoice.finalPcwAmount,
                };
                pushToGoogleSheet(sheetData); 

                document.getElementById('invoiceForm').reset();
                document.getElementById('status-message').textContent = 'Invoice saved to database and sent to Google Sheet API!';
                document.getElementById('status-message').className = 'text-green-500 font-bold mt-2';

            } catch (error) {
                console.error("Error saving invoice: ", error);
                if (error?.code === 'permission-denied' || /insufficient permissions/i.test(String(error?.message))) {
                    document.getElementById('status-message').textContent = 'Permissions error: update Firestore rules to allow writes to artifacts/vat-totals-app/vat_records.';
                } else {
                    document.getElementById('status-message').textContent = 'Error saving invoice. Check console for details.';
                }
                document.getElementById('status-message').className = 'text-red-500 font-bold mt-2';
            }
        };

        // Delete functionality removed per request

        // Real-time listener and UI update function
        window.setupRealtimeListener = (filter = 'all') => {
            if (!vatRecordsRef) return;
            
            // Get the reference date from the input field
            const referenceDateString = document.getElementById('filterDate')?.value || null;
            currentFilter = filter;
            currentReferenceDate = referenceDateString;

            const range = getDateRange(filter, referenceDateString);
            
            // Note: Firestore does not support combining range queries (timestamp >=) and orderBy() 
            // without composite indexes, so we filter by date range if applicable and sort client-side.
            
            let filterQuery = vatRecordsRef;

            if (filter !== 'all') {
                 // Use range query for date filtering
                 filterQuery = query(vatRecordsRef, where('timestamp', '>=', range.startDate), where('timestamp', '<', range.endDate));
            } 
            // We do not use orderBy() in the query to avoid potential index errors and instead sort client-side.
            
            const unsubscribe = onSnapshot(filterQuery, (snapshot) => {
                let totalHMRC = 0; // 10.5% of gross
                let totalPCW = 0;  // retained VAT
                let totalGross = 0; // gross
                let totalNet = 0;   // net (gross without 20% VAT)
                const invoiceTableBody = document.getElementById('invoiceTableBody');
                invoiceTableBody.innerHTML = '<tr id="loading-row"><td colspan="8" class="text-center py-4 text-gray-500">Loading records...</td></tr>';
                
                const allInvoices = [];
                snapshot.forEach((doc) => {
                    allInvoices.push({ id: doc.id, ...doc.data() });
                });
                
                // Clear the loading message once data is fetched (even if empty)
                invoiceTableBody.innerHTML = '';
                
                // --- SORTING LOGIC: Invoice Number (Ascending) then Date (Descending/Newest First) ---
                allInvoices.sort((a, b) => {
                    // 1. Primary Sort: Invoice Number (Ascending) - Case Insensitive
                    const numA = (a.invoiceNumber || '').toUpperCase();
                    const numB = (b.invoiceNumber || '').toUpperCase();

                    if (numA < numB) {
                        return -1;
                    }
                    if (numA > numB) {
                        return 1;
                    }

                    // 2. Secondary Sort: Date/Timestamp (Descending - newest first)
                    // Convert Firestore Timestamps or date strings to Date objects for comparison
                    const dateA = a.timestamp ? a.timestamp.toDate() : (a.date ? new Date(a.date) : new Date(0));
                    const dateB = b.timestamp ? b.timestamp.toDate() : (b.date ? new Date(b.date) : new Date(0));
                    
                    // Descending sort (B - A)
                    return dateB.getTime() - dateA.getTime();
                });
                // --- END SORTING LOGIC ---

                // Cache for export/print
                latestInvoices = allInvoices;

             if (allInvoices.length === 0) {
                 invoiceTableBody.innerHTML = '<tr id="no-records-row"><td colspan="8" class="text-center py-4 text-gray-500">No records found for this period.</td></tr>';
                }

                allInvoices.forEach((invoice) => {
                    const data = invoice;
                    const id = invoice.id;
                    // Ensure parsing only happens if data exists and is a valid number string
                    const hmrc = parseFloat(data.hmrcFlatRateAmount || 0);
                    const pcw = parseFloat(data.pcwRetainedVat || 0);
                    const gross = parseFloat(data.totalPrice || 0);
                    const net = parseFloat(data.netPrice || 0);

                    totalHMRC += hmrc;
                    totalPCW += pcw;
                    totalGross += gross;
                    totalNet += isNaN(net) ? 0 : net;

                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    const formattedDate = data.timestamp 
                        ? data.timestamp.toDate().toLocaleDateString('en-GB') 
                        : (data.date || 'N/A');

                    row.innerHTML = `
                        <td class="py-2 px-4 text-sm">${formattedDate}</td>
                        <td class="py-2 px-4 text-sm">${data.invoiceNumber || 'N/A'}</td>
                        <td class="py-2 px-4 text-sm text-right">£${parseFloat(data.netPrice).toFixed(2)}</td>
                        <td class="py-2 px-4 text-sm text-right">£${gross.toFixed(2)}</td>
                        <td class="py-2 px-4 text-sm text-right text-green-600">£${parseFloat(data.vat20Percent).toFixed(2)}</td>
                        <td class="py-2 px-4 text-sm text-right text-red-600">£${hmrc.toFixed(2)}</td>
                        <td class="py-2 px-4 text-sm text-right text-blue-600">£${pcw.toFixed(2)}</td>
                        <td class="py-2 px-4 text-sm text-right font-bold text-indigo-700">£${parseFloat(data.finalPcwAmount).toFixed(2)}</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });

                // Update Summary Cards
                document.getElementById('total-hmrc').textContent = `£${totalHMRC.toFixed(2)}`;
                document.getElementById('total-pcw').textContent = `£${totalPCW.toFixed(2)}`;
                document.getElementById('total-gross').textContent = `£${totalGross.toFixed(2)}`;
                document.getElementById('records-count').textContent = allInvoices.length;

                // Update cached totals and refresh top banner
                latestTotals = { hmrc: totalHMRC, net: totalNet, gross: totalGross };
                updateTopBanner();

                // Update filter button styles
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    // Check if the button ID matches the current filter
                    if (btn.id === `${filter}-filter`) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                document.getElementById('invoiceTableBody').innerHTML = '<tr id="error-row"><td colspan="8" class="text-center py-4 text-red-500">Error loading records. See console.</td></tr>';
                latestTotals = { hmrc: 0, net: 0, gross: 0 };
                updateTopBanner();
            });
            // Cleanup function returned for potential future use, though not strictly needed here
            return unsubscribe; 
        };

        // Column toggles helpers
        const columnConfig = [
            { key: 'date', title: 'Date', locked: true },
            { key: 'invoiceNumber', title: 'Invoice Number', locked: true },
            { key: 'netPrice', title: 'Net Price (£)' },
            { key: 'totalPrice', title: 'Gross (£)' },
            { key: 'vat20Percent', title: '20% VAT' },
            { key: 'hmrcFlatRateAmount', title: 'HMRC FRS (10.5%)' },
            { key: 'pcwRetainedVat', title: 'PCW Retained' },
            { key: 'finalPcwAmount', title: 'Final PCW (£)' }
        ];

        window.toggleColumn = (btn) => {
            if (btn.dataset.locked === 'true') return; // always on
            const pressed = btn.getAttribute('aria-pressed') === 'true';
            const now = !pressed;
            btn.setAttribute('aria-pressed', String(now));
            btn.classList.toggle('bg-green-600', now);
            btn.classList.toggle('text-white', now);
            btn.classList.toggle('bg-red-500', !now);
            btn.classList.toggle('text-white', !now);
        };

        const getSelectedColumns = () => {
            const buttons = document.querySelectorAll('#column-toggle-group .col-toggle');
            const selected = [];
            buttons.forEach(b => {
                if (b.getAttribute('aria-pressed') === 'true') selected.push(b.dataset.key);
            });
            // Ensure locked columns present
            if (!selected.includes('date')) selected.unshift('date');
            if (!selected.includes('invoiceNumber')) selected.splice(1, 0, 'invoiceNumber');
            return selected;
        };

        const formatDateCell = (inv) => {
            const d = inv.timestamp ? inv.timestamp.toDate() : (inv.date ? new Date(inv.date) : null);
            return d ? d.toLocaleDateString('en-GB') : '';
        };

        const getValue = (inv, key) => {
            if (key === 'date') return formatDateCell(inv);
            if (key === 'invoiceNumber') return inv.invoiceNumber || '';
            const val = parseFloat(inv[key] ?? '');
            return isNaN(val) ? '' : val.toFixed(2);
        };

        const csvEscape = (s) => {
            const str = String(s ?? '');
            if (/[",\n]/.test(str)) return '"' + str.replace(/"/g, '""') + '"';
            return str;
        };

        const buildPeriodLabel = () => {
            if (currentFilter === 'all') return 'All-Time';
            if (!currentReferenceDate) return currentFilter;
            // Derive start/end similar to getDateRange
            const { startDate, endDate } = getDateRange(currentFilter, currentReferenceDate);
            const fmt = (d) => d.toLocaleDateString('en-GB');
            // endDate is exclusive, subtract 1 day
            const end = new Date(endDate);
            end.setDate(end.getDate() - 1);
            return `${currentFilter} ${fmt(startDate)} to ${fmt(end)}`;
        };

        window.exportSelectedPeriod = () => {
            if (!latestInvoices || latestInvoices.length === 0) {
                alert('No records to export for the selected period.');
                return;
            }
            const cols = getSelectedColumns();
            const headers = cols.map(k => (columnConfig.find(c => c.key === k)?.title) || k);
            const rows = latestInvoices.map(inv => cols.map(k => csvEscape(getValue(inv, k))).join(','));
            const csv = ['\uFEFF' + headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const label = buildPeriodLabel().replace(/\s+/g, '_');
            link.href = url;
            link.download = `vat_export_${label}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        window.printSelectedPeriod = () => {
            if (!latestInvoices || latestInvoices.length === 0) {
                alert('No records to print for the selected period.');
                return;
            }
            const cols = getSelectedColumns();
            const headers = cols.map(k => (columnConfig.find(c => c.key === k)?.title) || k);
            const label = buildPeriodLabel();
            const htmlRows = latestInvoices.map(inv => '<tr>' + cols.map(k => `<td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;text-align:${['date','invoiceNumber'].includes(k)?'left':'right'}">${getValue(inv, k)}</td>`).join('') + '</tr>').join('');
            const table = `
                <table style="width:100%;border-collapse:collapse;font-family:Arial, sans-serif;font-size:12px;">
                    <thead>
                        <tr>${headers.map(h => `<th style=\"padding:8px 10px;text-align:left;border-bottom:2px solid #111827;\">${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>${htmlRows}</tbody>
                </table>`;
            const w = window.open('', '_blank');
            if (!w) return alert('Popup blocked. Please allow popups to print.');
            w.document.write(`<!DOCTYPE html><html><head><title>VAT ${label}</title><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"><style>@media print { body { -webkit-print-color-adjust: exact; } }</style></head><body><h2 style=\"font-family:Arial,sans-serif\">VAT Records — ${label}</h2>${table}<script>window.onload=function(){window.focus();window.print();setTimeout(function(){window.close();},300);};<\/script></body></html>`);
            w.document.close();
        };

        window.exportSelectedPeriodPDF = () => {
            if (!latestInvoices || latestInvoices.length === 0) {
                alert('No records to export for the selected period.');
                return;
            }
            const jspdfUMD = window.jspdf;
            const JSPDFCtor = jspdfUMD?.jsPDF || window.jsPDF; // support older globals just in case
            if (!JSPDFCtor) {
                alert('PDF library not loaded yet. Please try again in a moment.');
                return;
            }
            const cols = getSelectedColumns();
            const headers = cols.map(k => (columnConfig.find(c => c.key === k)?.title) || k);
            const body = latestInvoices.map(inv => cols.map(k => getValue(inv, k)));
            const label = buildPeriodLabel();

            const doc = new JSPDFCtor({ orientation: 'p', unit: 'pt', format: 'a4' });
            if (typeof doc.autoTable !== 'function') {
                alert('PDF table plugin not loaded yet. Please try again in a moment.');
                return;
            }
            doc.setFontSize(14);
            doc.text(`VAT Records — ${label}`, 40, 40);
            doc.setFontSize(10);
            doc.autoTable({
                startY: 60,
                head: [headers],
                body,
                styles: { fontSize: 9, cellPadding: 4 },
                headStyles: { fillColor: [17, 24, 39], textColor: 255 },
                columnStyles: cols.reduce((acc, k, idx) => {
                    acc[idx] = { halign: (k === 'date' || k === 'invoiceNumber') ? 'left' : 'right' };
                    return acc;
                }, {})
            });
            const filename = `vat_export_${label.replace(/\s+/g, '_')}.pdf`;
            doc.save(filename);
        };

        // Toggle visibility of the reconcile panel
        window.toggleReconcile = () => {
            const panel = document.getElementById('reconcile-panel');
            const btn = document.getElementById('reconcile-toggle-btn');
            if (!panel || !btn) return;
            const nowHidden = panel.classList.toggle('hidden');
            btn.textContent = nowHidden ? 'Show Tools' : 'Hide Tools';
            btn.setAttribute('aria-expanded', String(!nowHidden));
        };
        
        // Bulk remove Firestore invoices by invoice number (to match manual Sheet deletions)
        window.bulkRemoveInvoices = async () => {
            if (!vatRecordsRef) return;
            const text = (document.getElementById('bulkInvoiceNumbers')?.value || '').trim();
            const statusEl = document.getElementById('bulk-status');
            if (!text) {
                if (statusEl) { statusEl.textContent = 'Enter one or more invoice numbers (one per line).'; statusEl.className = 'text-red-600 text-sm mt-2'; }
                return;
            }
            const list = Array.from(new Set(text.split(/\r?\n/).map(s => s.trim()).filter(Boolean)));
            const ok = confirm(`Remove ${list.length} invoice(s) from the UI (Firestore)? This does not touch the Google Sheet.`);
            if (!ok) return;
            let removedById = 0, removedByQuery = 0, errors = 0;
            for (const inv of list) {
                try {
                    // Try delete by doc ID (new scheme)
                    await deleteDoc(doc(vatRecordsRef, inv));
                    removedById++;
                    // Also attempt legacy docs where ID != invoiceNumber
                    const q = query(vatRecordsRef, where('invoiceNumber', '==', inv));
                    const snaps = await getDocs(q);
                    const deletions = [];
                    snaps.forEach(d => deletions.push(deleteDoc(doc(vatRecordsRef, d.id))));
                    if (deletions.length) {
                        await Promise.allSettled(deletions);
                        removedByQuery += deletions.length;
                    }
                } catch (e) {
                    console.error('Bulk remove error for', inv, e);
                    errors++;
                }
            }
            if (statusEl) {
                statusEl.textContent = `Removed ${removedById} by ID and ${removedByQuery} legacy record(s). ${errors ? errors + ' error(s).' : 'Done.'}`;
                statusEl.className = errors ? 'text-red-600 text-sm mt-2' : 'text-green-600 text-sm mt-2';
            }
        };
        
        // Helper to handle date change and re-run filter
        window.handleDateChange = () => {
             // Find the currently active filter button
            const activeBtn = document.querySelector('.filter-btn.active');
            if (activeBtn) {
                const currentFilter = activeBtn.id.replace('-filter', '');
                window.setupRealtimeListener(currentFilter);
            }
        };


        window.initFirebase();
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">
            PCW Flat Rate VAT Manager
        </h1>
        <p id="user-id" class="text-sm text-gray-500 mb-6 text-center"></p>

        <!-- Real-time top total banner with mode selector -->
        <div id="hmrc-top-banner" class="mb-6 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800">
            <div class="flex flex-col sm:flex-row items-center gap-2 justify-between">
                <div class="text-center sm:text-left">
                    <span class="mr-2">Top total:</span>
                    <span id="hmrc-top-total" class="font-bold">£0.00</span>
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <span>Show:</span>
                    <select id="top-total-mode" class="border border-red-300 bg-white rounded px-2 py-1 text-sm">
                        <option value="hmrc" selected>HMRC (10.5%)</option>
                        <option value="net">Net (ex VAT)</option>
                        <option value="gross">Gross</option>
                    </select>
                </label>
            </div>
        </div>

        <!-- New Invoice Entry Form -->
        <div class="container-card mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Record New Invoice (FRS 10.5%)</h2>
            
            <form id="invoiceForm" onsubmit="saveInvoice(event)" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                
                <div>
                    <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 mb-1">Invoice No.</label>
                    <!-- Force consistent height -->
                    <input type="text" id="invoiceNumber" placeholder="INV-001" required class="input-style w-full h-10">
                </div>

                <div>
                    <label for="invoiceDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <!-- Force consistent height -->
                    <input type="date" id="invoiceDate" required class="input-style w-full h-10">
                </div>
                
                <div>
                    <label for="totalGross" class="block text-sm font-medium text-gray-700 mb-1">Total Price (Gross £)</label>
                    <!-- Force consistent height -->
                    <input type="number" id="totalGross" step="0.01" min="0.01" placeholder="120.00" required class="input-style w-full h-10">
                </div>
                
                <button type="submit" class="btn-primary w-full sm:w-auto">
                    Add Invoice
                </button>
            </form>
            <p id="status-message" class="mt-4 text-center"></p>
        </div>

        <!-- Summary & Filter Controls -->
        <div class="container-card mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Summary Totals</h2>
            
            <!-- Date Input -->
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                <label for="filterDate" class="text-sm font-medium text-gray-700 whitespace-nowrap">Filter **Reference Date**:</label>
                <input type="date" id="filterDate" class="input-style w-full sm:w-auto" onchange="handleDateChange()">
            </div>
            
            <!-- Filter Buttons -->
            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <button id="daily-filter" onclick="setupRealtimeListener('daily')" class="filter-btn">Daily</button>
                <button id="weekly-filter" onclick="setupRealtimeListener('weekly')" class="filter-btn">Weekly</button>
                <button id="monthly-filter" onclick="setupRealtimeListener('monthly')" class="filter-btn">Monthly</button>
                <button id="yearly-filter" onclick="setupRealtimeListener('yearly')" class="filter-btn">Yearly</button>
                <button id="all-filter" onclick="setupRealtimeListener('all')" class="filter-btn active">All Time</button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="summary-box">
                    <p class="text-sm font-medium text-gray-600">Total VAT to pay to HMRC (10.5%)</p>
                    <p id="total-hmrc" class="text-2xl font-bold text-red-700 mt-1">£0.00</p>
                    <p class="text-xs text-gray-500 mt-1" id="records-count-hmrc">VAT payable based on <span id="records-count">0</span> records.</p>
                </div>
                
                <div class="summary-box border-left-4 border-green-500">
                    <p class="text-sm font-medium text-gray-600">Total VAT Retained (PCW Profit)</p>
                    <p id="total-pcw" class="text-2xl font-bold text-green-700 mt-1">£0.00</p>
                    <p class="text-xs text-gray-500 mt-1">Total VAT profit (20% VAT - 10.5% FRS)</p>
                </div>

                <div class="summary-box border-left-4 border-gray-500">
                    <p class="text-sm font-medium text-gray-600">Total Gross Turnover</p>
                    <p id="total-gross" class="text-2xl font-bold text-gray-800 mt-1">£0.00</p>
                    <p class="text-xs text-gray-500 mt-1">Sum of all invoice gross totals.</p>
                </div>
            </div>
        </div>

        <!-- Tools toggle -->
        <div class="flex justify-end mb-3">
            <button id="reconcile-toggle-btn" onclick="toggleReconcile()" aria-controls="reconcile-panel" aria-expanded="false" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">Show Tools</button>
        </div>

        <!-- Reconcile UI with Google Sheet deletions (hidden by default) -->
        <div id="reconcile-panel" class="container-card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">Reconcile UI with Sheet</h2>
            <p class="text-sm text-gray-600 mb-3">Paste invoice numbers you removed from the Google Sheet (one per line) to remove them from the UI (Firestore).</p>
            <textarea id="bulkInvoiceNumbers" rows="3" placeholder="INV-001\nINV-002" class="input-style w-full mb-2"></textarea>
            <div class="flex justify-end">
                <button onclick="bulkRemoveInvoices()" class="px-4 py-2 rounded bg-gray-800 text-white hover:bg-black">Remove From UI</button>
            </div>
            <p id="bulk-status" class="text-sm mt-2"></p>
            <hr class="my-4 border-gray-200" />
            <h2 class="text-xl font-semibold mb-2 text-gray-700">Export / Print Selected Period</h2>
            <p class="text-sm text-gray-600 mb-3">Choose the columns to include. Date and Invoice Number are always included.</p>
            <div id="column-toggle-group" class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3">
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="date" data-locked="true" aria-pressed="true">Date</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="invoiceNumber" data-locked="true" aria-pressed="true">Invoice Number</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="netPrice" aria-pressed="true" onclick="toggleColumn(this)">Net Price (£)</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="totalPrice" aria-pressed="true" onclick="toggleColumn(this)">Gross (£)</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="vat20Percent" aria-pressed="true" onclick="toggleColumn(this)">20% VAT</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="hmrcFlatRateAmount" aria-pressed="true" onclick="toggleColumn(this)">HMRC FRS (10.5%)</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="pcwRetainedVat" aria-pressed="true" onclick="toggleColumn(this)">PCW Retained</button>
                <button type="button" class="col-toggle px-3 py-2 rounded bg-green-600 text-white" data-key="finalPcwAmount" aria-pressed="true" onclick="toggleColumn(this)">Final PCW (£)</button>
            </div>
            <div class="flex flex-wrap gap-2 justify-end">
                <button onclick="exportSelectedPeriod()" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Export CSV</button>
                <button onclick="exportSelectedPeriodPDF()" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Export PDF</button>
                <button onclick="printSelectedPeriod()" class="px-4 py-2 rounded bg-gray-700 text-white hover:bg-gray-800">Print</button>
            </div>
        </div>

        <!-- Invoice List -->
        <div class="container-card overflow-x-auto">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Invoice Records</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice No.</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net Price (£)</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gross (£)</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">20% VAT</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">HMRC FRS (10.5%)</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">PCW Retained</th>
                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Final PCW (£)</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Invoice rows will be inserted here by JavaScript -->
                    <tr id="loading-row"><td colspan="8" class="text-center py-4 text-gray-500">Loading records...</td></tr>
                </tbody>
            </table>
        </div>

    </div>
</body>
</html>
